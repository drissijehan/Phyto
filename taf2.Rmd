---
title: "TAF2"
author: "DRISSI Jihane"
date: "22 mai 2018"
output:
  html_document:
    df_print: paged
---


```{r, include=FALSE}
dataFolder <- "~/data"
library("DataManagement")
library(plotly)
library(reshape2)

```

#Quelle fiabilité des concentrations de substances dans les produits à partir des différents enregistrements de vente dans la BNVD ? 

##La concentration de chaque produit pour chaque année, code postal et substance:
```{r setup, include=FALSE}
load(file.path(dataFolder,"donnees_R","bnvdAcheteur","Table_Composition.rda"))
```

###Quantité produite et quantité des substances actives pour chaque produit par année, par code postal et par substance active
```{r,rows.print=7}
Table_Composition
```


```{r , include=FALSE}
df_mean<- aggregate(Concentration~AMM+Substance, data = Table_Composition, mean)
df_mean <- ChangeNameCol(df_mean,"Concentration","Mean")
df_sd<- aggregate(Concentration~AMM+Substance, data = Table_Composition, sd)
df_sd <- ChangeNameCol(df_sd,"Concentration","Sd")
df2<- merge(df_mean,df_sd,by=c("AMM","Substance"))
df2$CoefVar <- df2$Sd / df2$Mean
```

### Homogénéité des concentrations de substance par produits dans la BNVD

```{r,rows.print=7}
df2
```

###Coefficient de Variation des concentrations de substance par produit dans la BNVD(Sd/Mean)
```{r, echo=FALSE}
plot_ly(df2, x = ~ CoefVar, type = "histogram", text = ~paste("AMM:", AMM, "Substance:" , Substance)) 
```

On a **481** observations ignorées, ceci est expliqué par **438** observations où on a Sd==NA (une seule vente pour le couple AMM+Substance), et **61** observations où la moyenne est nulle donc le ratio NA. Enfin, **18** observations où Sd==NA et Mean==0. Alors, on trouve bien: **481=438+61-18**.

Combien de produits avec un coefficient de variation supérieur à 10%.
```{rentent 5/10000
length(unique(df2[which(df2$CoefVar>0.1),]$AMM))
```
Cela représente 5/10000 de la quantité totale de produit présente dans la BNVD. 

```{r, include=FALSE}
load(file.path(dataFolder,"donnees_R","bnvdAcheteur","Table_Correspondance.rda"))
```
###Table des présences des produits dans les bases BNVD, EPHY et PK avec DH mediane et composition 
```{r  rows.print=7, paged.print= TRUE}
Table_Correspondance
```

Attention NA:
      Dose Homologué == NA --> AMM n'est pas présent dans EPHY ou Dose Homologuée (Dose d'application retenue) est NA à la base dans EPHY.
      Composition == NA --> AMM n'est pas présent dans BNVD (propriétés testées dans df.R).

###Distribution de tous les produits dans EPHY, BNVD et PK
#### Table des effectifs
```{r, include=FALSE}
df6<- table(PK=Table_Correspondance$PK,BNVD=Table_Correspondance$BNVD,EPHY=Table_Correspondance$EPHY)
df6<-as.data.frame(df6)
df6<-t(df6)
df6<-as.data.frame(df6)
```

```{r,,rows.print=8}
df6
```

#### Histogramme des effectifs
```{r, include=FALSE}
d<-t(df6)
d<-as.data.frame(d)
d$barplot<-c("---","E--","-B-","EB-","--P","E-P","-BP","EBP")
d$barplot<- as.factor(d$barplot)
d$Freq<-as.numeric(levels(d$Freq))

oind <- order(as.numeric(by(-(d$Freq), d$barplot, median)))    
d$barplot <- ordered(d$barplot, levels=levels(d$barplot)[oind]) 
p <- plot_ly(d,
  x = ~barplot,
  y = ~Freq,
  name = "Effectif",
  type = "bar"
)
```

```{r}
p
```
Note: 
Il y a 1822 produits présents dans EPHY mais pas utilisés, c'est compréhensible car EPHY sur 2008-2017 alors que BNVD est sur 2013-2017 et PK 2014 seulement. 
800 produits que dans la BNVD, probablement lié aux catégories manquantes dans EPHY (adjuvants, etc.) et limitation de PK par rapport à la BNVD (seulement 2014 et seulement grandes cultures).
1942 produits manquant dans PK pouvant être des produits peu utilisés mais aussi des produits qui ne sont pas utilisés en 2014 ou pas en grandes cultures). 
7 produits dans PK non homologués, non vendus, probablement des erreurs de saisies d'AMM dans PK
22 produits dans EPHY et PK mais pas dans BNVD, peut-être des erreurs de saisies dans PK qui seraient des adjuvants donc pas dans EPHY (à véririfier?). 
Les 141 dans BNVD et PK sans être dans EPHY sont notamment des adjuvants (vérifié à la main). 

En conclusion peu de produits sont présents dans les trois tables ($612/4399$), et notamment beaucoup de produits absents dans PK GC 2014. 

###Mention des cultures pour chaque produit dans EPHY et PK
Union des lignes culture x produit dans Ephy et PK.
Une ligne par produit et par culture d'application dans PK ou EPHY. Indique pour chaque produit si la culture (Espece) et le produit (Amm) sont présents dans Ephy et Pk; indique aussi la dose homologuée mediane pour la culture le produit dans EPHY. 
```{r}
load(file.path(dataFolder,"donnees_R","EPHY","CorrespondanceEphyPk.rda"))
```

```{r}
CorrespondanceEphyPk
```

###Effectif des produits classés (GC ou TC) et Usage professionnel dans EPHY 
```{r, include=FALSE}
load(file.path(dataFolder,"donnees_R","EPHY","EPHY.rda"))
n1=length(unique(EPHY$AMM))
n2=length(unique(EPHY[EPHY$Gamme.d.usages%in%"Professionnel",]$AMM))
isGC <- EPHY$Filiere%in%"Grandes cultures"
n3=length(unique(EPHY[isGC,]$AMM))
isTC <- EPHY$Filiere%in%"Traitements généraux toutes cultures"
n4=length(unique(EPHY[isTC,]$AMM))
n5=length(unique(EPHY[isTC & isGC,]$AMM))

df5 <- data.frame(Total = n1, UsagePro = n2, GC = n3 , TC = n4, GCetTC = n5)
```

```{r}
df5
```


###Distribution des produits dans BNVD et PK, restreint aux produits GC ou TC, usage professionel dans EPHY
```{r, include=FALSE}
load(file.path(dataFolder,"donnees_R","bnvdAcheteur","Table_Distribution.rda"))
```

```{r}
Table_Distribution
```


###Répartition des produits présents ou pas dans EPHY (Grands, tous cultures et usage professionnel), BNVD et PK par catégorie
```{r, include=FALSE}
dat<-Table_Distribution
dat$barplot<-c("---","E--","-B-","EB-","--P","E-P","-BP","EBP")
p <- plot_ly(dat, x = ~barplot, y = ~Fongicide.Freq, type = 'bar', name = 'Fongicide') %>%
  add_trace(y = ~Herbicide.Freq, name = 'Herbicide') %>%
   add_trace(y = ~Insecticide.Freq, name = 'Insecticide') %>%
   add_trace(y = ~Molluscicide.Freq, name = 'Molluscicide') %>%
   add_trace(y = ~Acaricide.Freq, name = 'Acaricide') %>%
   add_trace(y = ~Taupicide.Freq, name = 'Taupicide') %>%
   
   add_trace(y = ~Virucide.Freq, name = 'Virucide') %>%
   add_trace(y = ~Dévitalisation.Freq, name = 'Dévitalisation') %>%
   add_trace(y = ~Bactéricide.Freq, name = 'Bactéricide') %>%
   add_trace(y = ~Nématicide.Freq, name = 'Nématicide') %>%
   add_trace(y = ~Stimulateur.des.défenses.naturelles.Freq, name = 'Stimulateur.des.défenses.naturelles') %>%
  layout(yaxis = list(title = 'Count'), barmode = 'stack')
```

```{r}
p
```

Domination claire des Insecticides, Herbicides et fongicides, sans variation très nette des proportions entre les différentes classes de présence dans les bases, sauf pour les produits qui sont dans PK mais pas dans la BNBD (--P et E-P) où les autres types de produits sont sur-représentés (bizarre que ce soit simplement des erreurs d'entrée vu que ça touche spécifiquement les taupicides et bactéricides notamment.  

###Répartition des produits présents ou pas dans PK par catégorie

```{r, include=FALSE}
dat<-Table_Distribution
dat$barplot<-c("---","E--","-B-","EB-","--P","E-P","-BP","EBP")
dat<-dat[dat$barplot%in%c("EB-","EBP"),]

p <- plot_ly(dat, x = ~barplot, y = ~Fongicide.Freq, type = 'bar', name = 'Fongicide') %>%
  add_trace(y = ~Herbicide.Freq, name = 'Herbicide') %>%
   add_trace(y = ~Insecticide.Freq, name = 'Insecticide') %>%
   add_trace(y = ~Molluscicide.Freq, name = 'Molluscicide') %>%
   add_trace(y = ~Acaricide.Freq, name = 'Acaricide') %>%
   add_trace(y = ~Taupicide.Freq, name = 'Taupicide') %>%
   
   add_trace(y = ~Virucide.Freq, name = 'Virucide') %>%
   add_trace(y = ~Dévitalisation.Freq, name = 'Dévitalisation') %>%
   add_trace(y = ~Bactéricide.Freq, name = 'Bactéricide') %>%
   add_trace(y = ~Nématicide.Freq, name = 'Nématicide') %>%
   add_trace(y = ~Stimulateur.des.défenses.naturelles.Freq, name = 'Stimulateur.des.défenses.naturelles') %>%
  layout(yaxis = list(title = 'Count'), barmode = 'stack')

```

```{r}
p
```

Ce qui manque principalement dans PK semble être des insecticides et des fongicides.

###Répartition des produits présents ou pas dans EPHY, BNVD, PK en se basant sur le volume BNVD

```{r, include=FALSE}
load(file.path(dataFolder,"donnees_R","bnvdAcheteur","DistribustionVolume.rda"))

Dist<- aggregate(QBNVD~T_F+Fonction, data = DistribustionVolume, sum)
Dist_Cast<-dcast(Dist, T_F~Fonction)

```

```{r}
DistribustionVolume
```

```{r, include=FALSE}

p <- plot_ly(Dist_Cast, x = ~T_F, y = ~Herbicide, type = 'bar', name = 'Herbicide') %>%
  add_trace(y = ~Fongicide, name = 'Fongicide') %>%
  add_trace(y = ~Insecticide, name = 'Insecticide') %>%
  add_trace(y = ~Molluscicide, name = 'Molluscicide') %>%
  add_trace(y = ~Acaricide, name = 'Acaricide') %>%
  add_trace(y = ~Dévitalisation, name = 'Dévitalisation') %>%
  add_trace(y = ~Bactéricide, name = 'Bactéricide') %>%
  
  layout(yaxis = list(title = 'Volume BNVD'), barmode = 'stack')

```

```{r}
p
```

Warnings: correspond aux observations pour lesquelles il n'y a pas de volumes parce qu'ils ne sont pas dans la BNVD (explique barres manquantes, vérifier pq certaines barres vraiment manquantes et d'autres à zéro). 

Conclusion: PK GC documente la majorité des quantité vendues étiquetées GC ou TC dans ephy, malgré les manques importants soulignés précédemment. Cela signifie que les utilisations de produits en grandes cultures sont dominantes dans les ventes (`ratio (-BP+EBP)/total`). Mais une part non négligeable $ratio (-B- + -BP)/(total)$) de produit est vendue sans être dans EPHY (adjuvants, etc.? bizarre quand même que la catégorie soit documentée, en tout cas fongicides très sur représentés, explorer ce que ça représente car c'est presque la moitié des fongicides) et une autre part importante ($ratio (EB-)/total$) est probablement utilisée ailleurs qu'en grandes cultures. 

Pour le vérifier on pose la question suivante :

Q: Y-a-t il des produits GC ou TC, usage pro, dans Ephy dont les ventes sont importantes sans être documentées dans PK? 

Ajouter même graphique mais en gardant tous les produits qui ne sont pas GC ou TC dans Ephy (même si on perd encore des barres). (mettre ce graph en premier).
Ajouter ratio de la nouvelle barre EB- par rapport à (EB- + EBP): le ratio des quantités vendus à priori sur grandes cultures qui ne sont pas documentées dans PK. Voir ajouter aussi ce ratio en se restreingnant à GC et usage pro (pas TC). 

En ce qui concerne la répartition des catégories de produits dans les bases. Les herbicides sont sur-représentés dans les EBP suggèrant que les grandes cultures représentent de très loin la majorité des usages d'herbicides. 

Proportions à revoir quand on aura que Ephy GC+TC

Ajouter même graphique mais en se limitant aux produits qui ne sont documentés dans Ephy **que** pour GC et usage pro, pas TC ni autres cultures. 
